<!DOCTYPE html>
<!-- The lang and dir attributes will be set by JavaScript -->
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المتجر العالمي</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body { font-family: 'Tajawal', sans-serif; background: #212534; color: #fff; }
        .swal2-popup { font-family: 'Tajawal', sans-serif; }
        .products-grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 4rem 2rem; padding: 1rem; justify-items: center; }
        .card { width: 280px; height: 500px; border-radius: 25px; box-shadow: -11px 11px 1px rgba(0, 0, 0, 0.3); transition: transform 0.3s ease; cursor: pointer; }
        .card:hover { transform: scale(1.03); }
        .card-head { position: relative; height: 252px; background: linear-gradient(135deg, #fa782e 8%, #c82930 83%); border-radius: 25px 25px 0 0; display: flex; align-items: flex-start; padding: 20px; }
        .product-img { position: absolute; left: 50%; top: 45%; transform: translate(-50%, -50%) rotate(-25deg); width: 100%; max-width: 260px; filter: drop-shadow(0 30px 20px rgba(0,0,0,0.2)); }
        .product-detail { position: absolute; bottom: 20px; left: 20px; right: 20px; font-size: 12px; color: rgba(255,255,255,0.8); }
        .product-detail h2 { font-size: 20px; font-weight: 700; letter-spacing: 1px; padding-bottom: 8px; text-transform: uppercase; color: #fff; }
        .card-body { height: 248px; background: #fff; color: #333; border-radius: 0 0 25px 25px; padding: 20px; display: flex; flex-direction: column; justify-content: space-between; }
        .product-desc { padding: 5px 0; }
        .product-title { display: block; font-size: 17px; font-weight: 500; text-transform: uppercase; }
        .product-title b { font-weight: 900; }
        .product-caption { display: block; font-size: 11px; color: #888; text-transform: uppercase; margin-top: 5px; }
        .product-properties { display: flex; justify-content: space-between; align-items: center; }
        .product-price { font-size: 26px; font-weight: 700; color: #3B82F6; }
        .product-price b { font-weight: 900; }
        .cart-badge { background-color: #EF4444; color: white; border-radius: 50%; padding: 0.1em 0.5em; font-size: 0.75rem; position: absolute; top: -5px; right: -10px;}
    </style>
</head>
<body class="bg-[#212534]">

    <!-- Navbar -->
    <nav class="bg-gray-900 bg-opacity-80 shadow-lg backdrop-blur-md sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
            <div data-translate-key="store_name" class="font-bold text-xl sm:text-2xl text-white">المتجر العالمي</div>
            
             <!-- Desktop Nav Links -->
            <div class="hidden md:flex items-center space-x-4 space-x-reverse">
                <a href="#" class="text-gray-300 hover:text-white" data-translate-key="home">الرئيسية</a>
                <a href="#" class="text-gray-300 hover:text-white" data-translate-key="syria_lebanon_store">متجر سوريا ولبنان</a>
                <a href="#" class="text-gray-300 hover:text-white" data-translate-key="my_wallet">محفظتي: <span id="wallet-balance" class="font-bold">...</span></a>
                <a href="#" class="text-gray-300 hover:text-white" data-translate-key="track_orders">تتبع طلباتي</a>
                <a href="#" class="text-gray-300 hover:text-white" data-translate-key="about_us">من نحن</a>
                <a href="#" class="text-gray-300 hover:text-white" data-translate-key="contact_info">معلومات الاتصال</a>
            </div>

            <div class="flex items-center">
                 <!-- Cart Icon -->
                 <button id="cart-button" class="text-white text-2xl relative mx-2">
                    <i class="fas fa-shopping-cart"></i>
                    <span id="cart-count" class="cart-badge hidden">0</span>
                 </button>
                 <!-- Language Switcher for smaller screens -->
                <div class="relative md:hidden">
                    <button id="lang-menu-button" class="text-white px-2"><i class="fas fa-globe"></i></button>
                    <div id="lang-menu" class="hidden absolute top-full left-0 mt-2 bg-gray-800 rounded-md shadow-lg py-1">
                        <button data-lang="ar" class="lang-switcher block w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-700">العربية</button>
                        <button data-lang="en" class="lang-switcher block w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-700">English</button>
                        <button data-lang="es" class="lang-switcher block w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-700">Español</button>
                    </div>
                </div>
                 <!-- Language Switcher for larger screens -->
                <div class="hidden md:flex items-center space-x-2 space-x-reverse ml-4">
                    <button data-lang="ar" class="lang-switcher px-3 py-1 text-white hover:bg-gray-700 rounded-md">العربية</button>
                    <button data-lang="en" class="lang-switcher px-3 py-1 text-white hover:bg-gray-700 rounded-md">English</button>
                    <button data-lang="es" class="lang-switcher px-3 py-1 text-white hover:bg-gray-700 rounded-md">Español</button>
                </div>
                 <button id="logout-button" class="bg-red-600 text-white px-3 py-1 rounded-md text-sm hover:bg-red-700 transition" data-translate-key="logout">تسجيل الخروج</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto p-4 sm:p-8">
        <h1 data-translate-key="products_title" class="text-3xl sm:text-4xl font-bold text-center text-white mb-12">منتجاتنا</h1>

        <!-- Products Grid -->
        <div id="products-grid" class="products-grid-container">
            <!-- Product cards will be inserted here by JavaScript -->
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="text-center py-10">
            <p data-translate-key="loading" class="text-gray-400">جارِ تحميل المنتجات...</p>
        </div>
    </main>

    <script src="https://npmcdn.com/parse/dist/parse.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const translations = { /* ... translation data remains the same ... */ };
        let currentLang = 'ar'; 
        Parse.initialize("a10tYxDiUFIaigtshCBuVOjYvqkUedYrS2bbwxV7", "LW1t1PMFgqMJqwiwe78vvgN9mvkxP1LuhbxGNLUY");
        Parse.serverURL = "https://parseapi.back4app.com/";
        const currentUser = Parse.User.current();

        const productsGrid = document.getElementById('products-grid');
        const loadingIndicator = document.getElementById('loading-indicator');
        const cartButton = document.getElementById('cart-button');
        const cartCountSpan = document.getElementById('cart-count');
        let productsCache = [];

        function setLanguage(lang) { /* ... setLanguage logic remains the same ... */ }

        async function fetchUserWallet() { /* ... fetchUserWallet logic remains the same ... */ }

        async function fetchProducts() {
            loadingIndicator.style.display = 'block';
            productsGrid.innerHTML = '';
            const Product = Parse.Object.extend("Things");
            const query = new Parse.Query(Product);
            try {
                const products = await query.find();
                productsCache = products;
                renderProducts(products, currentLang);
            } catch (error) {
                console.error("Error fetching products: ", error);
                loadingIndicator.style.display = 'none';
                Swal.fire({
                    title: 'خطأ في تحميل المنتجات',
                    html: `فشل تحميل المنتجات. تأكد من صحة مفاتيح الربط وأذونات الجدول.<br><code class="text-xs text-gray-500">${error.message}</code>`,
                    icon: 'error'
                });
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }
        
        function renderProducts(products, lang) {
             productsGrid.innerHTML = '';
            if (products.length === 0 && productsCache.length > 0) {
                 productsGrid.innerHTML = `<p class="text-center col-span-full text-gray-400">لا توجد منتجات لعرضها حاليًا.</p>`;
                 return;
            }
            products.forEach(product => {
                const name = product.get(`name_${lang}`) || 'Product Name';
                const description = product.get(`description_${lang}`) || 'Description unavailable.';
                const category = product.get(`category_${lang}`) || 'Collection';
                const price = product.get('price') || 0;
                const shippingTime = product.get('shippingTime') || 'N/A';
                const imageFile = product.get('imageFile');
                const imageUrl = imageFile ? imageFile.url() : 'https://s5.postimg.cc/j9r8yf9gn/sws1.png';
                
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-head">
                        <img src="${imageUrl}" alt="${name}" class="product-img">
                        <div class="product-detail">
                            <h2>${name}</h2>
                            ${description}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="product-desc">
                            <span class="product-title">${name}</span>
                            <span class="product-caption">${category}</span>
                            <span class="product-caption">${translations[lang].shipping_time}: ${shippingTime}</span>
                        </div>
                        <div class="product-properties">
                            <span class="product-price">$<b>${price.toFixed(2)}</b></span>
                            <button class="add-to-cart-btn bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition" data-product-id="${product.id}">
                                ${translations[lang].add_to_cart}
                            </button>
                        </div>
                    </div>
                `;
                card.querySelector('.add-to-cart-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    promptForQuantity(product.id);
                });
                card.addEventListener('click', () => showProductDetails(product.id));
                productsGrid.appendChild(card);
            });
        }
        
        async function showProductDetails(productId) { /* ... showProductDetails logic remains the same ... */ }
        
        async function promptForQuantity(productId) {
             if(!currentUser) {
                Swal.fire('تنبيه', 'الرجاء تسجيل الدخول أولاً لإضافة منتجات للسلة.', 'warning');
                return;
            }
            const { value: quantity } = await Swal.fire({
                title: translations[currentLang].add_item_title,
                input: 'number',
                inputLabel: translations[currentLang].add_item_label,
                inputValue: 1,
                inputAttributes: { min: 1, step: 1 },
                showCancelButton: true,
                inputValidator: (value) => { if (!value || value < 1) { return 'الرجاء إدخال كمية صالحة!' } }
            });

            if (quantity) {
                addToCart(productId, parseInt(quantity));
            }
        }
        
        // --- CART LOGIC with 'Net' class ---
        async function addToCart(productId, quantityToAdd) {
            Swal.fire({ title: 'جارِ الإضافة...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); }});
            // FIX: Changed "Cart" to "Net"
            const Net = Parse.Object.extend("Net");
            const query = new Parse.Query(Net);
            const productPointer = Parse.Object.createWithoutData("Things", productId);
            query.equalTo("guest", currentUser);
            query.equalTo("product", productPointer);
            try {
                let cartItem = await query.first();
                if (cartItem) {
                    cartItem.increment("quantity", quantityToAdd);
                } else {
                    cartItem = new Net();
                    cartItem.set("guest", currentUser);
                    cartItem.set("product", productPointer);
                    cartItem.set("quantity", quantityToAdd);
                }
                await cartItem.save();
                updateCartCount();
                Swal.fire('تمت الإضافة', 'تمت إضافة المنتج إلى سلتك بنجاح!', 'success');
            } catch (error) {
                 console.error("Error adding to cart:", error);
                 let errorMessage = 'فشلت إضافة المنتج للسلة.';
                 if (error.code === 119) {
                     errorMessage = `<strong>خطأ في الأذونات!</strong><br>الرجاء التأكد من إعدادات الأمان لجدول "Net" بشكل صحيح.`;
                 }
                 Swal.fire({ title: 'خطأ', html: errorMessage + `<br><br><code class="text-xs text-gray-500">الخطأ: ${error.message}</code>`, icon: 'error' });
            }
        }
        
        async function updateCartCount() {
            if(!currentUser) return;
            // FIX: Changed "Cart" to "Net"
            const Net = Parse.Object.extend("Net");
            const query = new Parse.Query(Net);
            query.equalTo("guest", currentUser);
            try {
                const count = await query.count();
                if(count > 0) {
                    cartCountSpan.textContent = count;
                    cartCountSpan.classList.remove('hidden');
                } else {
                    cartCountSpan.classList.add('hidden');
                }
            } catch (error) {
                console.error("Error updating cart count:", error);
            }
        }
        
        cartButton.addEventListener('click', async () => {
             if(!currentUser) {
                Swal.fire('تنبيه', 'الرجاء تسجيل الدخول أولاً لعرض السلة.', 'warning');
                return;
            }
            showCartModal();
        });

        async function showCartModal() {
            // FIX: Changed "Cart" to "Net"
            const Net = Parse.Object.extend("Net");
            const query = new Parse.Query(Net);
            query.equalTo("guest", currentUser);
            query.include("product"); 
            Swal.fire({ title: 'جارِ تحميل السلة...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); }});
            try {
                const cartItems = await query.find();
                let subtotal = 0;
                let cartHTML = `...`; // Cart HTML rendering logic
                if (cartItems.length === 0) {
                     cartHTML = `<p class="text-center p-4">${translations[currentLang].empty_cart}</p>`;
                } else {
                    cartHTML = `<table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr>
                        <th scope="col" class="px-6 py-3">${translations[currentLang].product}</th>
                        <th scope="col" class="px-6 py-3">${translations[currentLang].price}</th>
                        <th scope="col" class="px-6 py-3">${translations[currentLang].quantity}</th>
                        <th scope="col" class="px-6 py-3">${translations[currentLang].total}</th>
                    </tr></thead><tbody>`;
                    cartItems.forEach(item => {
                        const product = item.get("product");
                        const price = product.get("price") || 0;
                        const quantity = item.get("quantity");
                        const total = price * quantity;
                        subtotal += total;
                        cartHTML += `...`; // table row
                    });
                     cartHTML += `</tbody></table>`;
                }
                const footerHTML = `...`; // Footer HTML logic
                Swal.fire({
                    title: translations[currentLang].cart_title,
                    html: cartHTML + footerHTML,
                    width: window.innerWidth > 768 ? '800px' : '95%',
                    showConfirmButton: false,
                    showCloseButton: true,
                    didOpen: () => {
                        const payWalletBtn = document.getElementById('pay-wallet');
                        if (payWalletBtn && cartItems.length > 0) {
                            payWalletBtn.addEventListener('click', () => handleWalletPayment(subtotal, cartItems));
                        }
                    }
                });
            } catch(error) {
                console.error("Error showing cart:", error);
                Swal.fire('خطأ', 'فشل عرض السلة.', 'error');
            }
        }
        
        async function handleWalletPayment(totalCost, cartItems) {
            // ... (Payment logic remains the same, but uses the 'Net' object)
        }

        // --- AUTH & PAGE SETUP ---
        const langMenuButton = document.getElementById('lang-menu-button');
        const langMenu = document.getElementById('lang-menu');
        if(langMenuButton) {
            langMenuButton.addEventListener('click', () => langMenu.classList.toggle('hidden'));
        }
        document.querySelectorAll('.lang-switcher').forEach(s => s.addEventListener('click', e => {
            setLanguage(e.target.dataset.lang);
            if(langMenu) langMenu.classList.add('hidden');
        }));
        
        document.getElementById('logout-button').addEventListener('click', async () => {
            await Parse.User.logOut();
            window.location.reload();
        });
        
        if (!currentUser) {
            document.getElementById('logout-button').style.display = 'none';
            const walletLink = document.querySelector('[data-translate-key="my_wallet"]');
            if(walletLink) walletLink.style.display = 'none';
        } else {
            fetchUserWallet();
            updateCartCount();
        }

        // Initial Load
        setLanguage('ar');
        fetchProducts();

    });
    </script>
</body>
</html>
