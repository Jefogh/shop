<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المتجر العالمي</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        body { font-family: 'Tajawal', sans-serif; background: #212534; color: #fff; }
        .swal2-popup { font-family: 'Tajawal', sans-serif; }
        .products-grid-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); 
            gap: 3rem 1.5rem; 
            padding: 1rem; 
            justify-items: center; 
        }
        .card { 
            width: 240px; 
            height: 440px; 
            border-radius: 25px; 
            box-shadow: -10px 10px 1px rgba(0, 0, 0, 0.2); 
            transition: transform 0.3s ease; 
            cursor: pointer; 
        }
        .card:hover { transform: scale(1.05); }
        .card-head { position: relative; height: 220px; background: linear-gradient(135deg, #fa782e 8%, #c82930 83%); border-radius: 25px 25px 0 0; display: flex; align-items: flex-start; padding: 15px; }
        .product-img { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%) rotate(-25deg); width: 100%; max-width: 220px; filter: drop-shadow(0 25px 15px rgba(0,0,0,0.2)); }
        .card-body { 
            height: 220px; 
            background: #fff; color: #333; border-radius: 0 0 25px 25px; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; 
        }
        .product-desc { padding: 5px 0; }
        .product-title { display: block; font-size: 16px; font-weight: 700; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .product-caption { display: block; font-size: 10px; color: #888; text-transform: uppercase; margin-top: 4px; }
        .product-properties { display: flex; justify-content: space-between; align-items: center; }
        .product-price { font-size: 24px; font-weight: 700; color: #3B82F6; }
        .cart-badge { background-color: #EF4444; color: white; border-radius: 50%; padding: 0.1em 0.5em; font-size: 0.75rem; position: absolute; top: -5px; right: -10px;}
        .product-rating { font-size: 13px; color: #facc15; }
        .rating-stars .fa-star { cursor: pointer; transition: color 0.2s; }
        .filter-input {
            background-color: #2d3748; border: 1px solid #4a5568; color: white;
            border-radius: 0.375rem; padding: 0.5rem 1rem;
        }
        .filter-input:focus {
            outline: none; border-color: #4299e1; box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.5);
        }
        .lang-modal-btn {
            width: 100%; padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid #4a5568;
            background-color: #2d3748; color: white; font-size: 16px; cursor: pointer; transition: background-color 0.2s;
        }
        .lang-modal-btn:hover { background-color: #4a5568; }
        #map { height: 300px; width: 100%; border-radius: 8px; z-index: 1; margin-bottom: 1rem;}
        .delivery-form-input { 
            width: 100%; background-color: #f0f2f5; color: #333; border: 1px solid #ccc; 
            border-radius: 5px; padding: 8px; margin-top: 4px; box-sizing: border-box;
        }
        .status-badge { padding: 0.2em 0.6em; border-radius: 10px; font-size: 0.8em; color: white; font-weight: bold; }
    </style>
</head>
<body class="bg-[#212534]">

    <nav class="bg-gray-900 bg-opacity-80 shadow-lg backdrop-blur-md sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 py-4">
            <div class="flex justify-between items-center">
                <div data-translate-key="store_name" class="font-bold text-xl sm:text-2xl text-white">المتجر العالمي</div>
                <div class="hidden md:flex items-center space-x-4 space-x-reverse">
                    <a href="main.html" class="text-gray-300 hover:text-white" data-translate-key="home">الرئيسية</a>
                    <a href="local.html" class="text-gray-300 hover:text-white" data-translate-key="syria_lebanon_store">متجر سوريا ولبنان</a>
                    <a href="wallet.html" class="text-gray-300 hover:text-white" data-translate-key="my_wallet">محفظتي: <span id="wallet-balance" class="font-bold">...</span></a>
                    <button id="track-orders-btn" class="text-gray-300 hover:text-white" data-translate-key="track_orders">تتبع طلباتي</button>
                    <a href="us.html" class="text-gray-300 hover:text-white" data-translate-key="about_us">من نحن</a>
                    <a href="contact.html" class="text-gray-300 hover:text-white" data-translate-key="contact_info">معلومات الاتصال</a>
                </div>
                <div class="flex items-center">
                     <button id="cart-button" class="text-white text-2xl relative mx-2"> <i class="fas fa-shopping-cart"></i> <span id="cart-count" class="cart-badge hidden">0</span> </button>
                     <button id="lang-globe-button" class="md:hidden text-white text-xl relative mx-2"> <i class="fas fa-globe"></i> </button>
                    <div class="md:hidden"> <button id="mobile-menu-button" class="text-white p-2"> <i class="fas fa-bars"></i> </button> </div>
                    <div class="hidden md:flex items-center space-x-2 space-x-reverse ml-4">
                        <button data-lang="ar" class="lang-switcher px-3 py-1 text-white hover:bg-gray-700 rounded-md">العربية</button>
                        <button data-lang="en" class="lang-switcher px-3 py-1 text-white hover:bg-gray-700 rounded-md">English</button>
                        <button data-lang="es" class="lang-switcher px-3 py-1 text-white hover:bg-gray-700 rounded-md">Español</button>
                    </div>
                     <a href="index.html" id="login-button" class="hidden bg-blue-600 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-700 transition" data-translate-key="login">تسجيل الدخول</a>
                     <button id="logout-button" class="hidden bg-red-600 text-white px-3 py-1 rounded-md text-sm hover:bg-red-700 transition" data-translate-key="logout">تسجيل الخروج</button>
                </div>
            </div>
            <div id="mobile-menu" class="hidden md:hidden mt-4">
                <a href="main.html" class="block py-2 px-4 text-sm text-gray-300 hover:bg-gray-700 rounded-md" data-translate-key="home">الرئيسية</a>
                <a href="local.html" class="block py-2 px-4 text-sm text-gray-300 hover:bg-gray-700 rounded-md" data-translate-key="syria_lebanon_store">متجر سوريا ولبنان</a>
                <a href="bank.html" class="block py-2 px-4 text-sm text-gray-300 hover:bg-gray-700 rounded-md" data-translate-key="my_wallet">محفظتي: <span id="wallet-balance-mobile" class="font-bold">...</span></a>
                <button id="track-orders-btn-mobile" class="block w-full text-left py-2 px-4 text-sm text-gray-300 hover:bg-gray-700 rounded-md" data-translate-key="track_orders">تتبع طلباتي</button>
                <a href="us.html" class="block py-2 px-4 text-sm text-gray-300 hover:bg-gray-700 rounded-md" data-translate-key="about_us">من نحن</a>
                <a href="connect.html" class="block py-2 px-4 text-sm text-gray-300 hover:bg-gray-700 rounded-md" data-translate-key="contact_info">معلومات الاتصال</a>
                <hr class="my-2 border-gray-700">
                <div class="px-4 py-2">
                    <p class="text-gray-400 text-xs mb-2" data-translate-key="language">اللغة</p>
                    <div class="flex justify-around">
                        <button data-lang="ar" class="lang-switcher px-3 py-1 text-white hover:bg-gray-700 rounded-md">العربية</button>
                        <button data-lang="en" class="lang-switcher px-3 py-1 text-white hover:bg-gray-700 rounded-md">English</button>
                        <button data-lang="es" class="lang-switcher px-3 py-1 text-white hover:bg-gray-700 rounded-md">Español</button>
                    </div>
                </div>
                 <hr class="my-2 border-gray-700">
                 <a href="index.html" id="login-button-mobile" class="hidden w-full text-left py-2 px-4 text-sm text-blue-400 hover:bg-gray-700 rounded-md" data-translate-key="login">تسجيل الدخول</a>
                 <button id="logout-button-mobile" class="hidden w-full text-left py-2 px-4 text-sm text-red-400 hover:bg-gray-700 rounded-md" data-translate-key="logout">تسجيل الخروج</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 sm:p-8">
        <h1 data-translate-key="products_title" class="text-3xl sm:text-4xl font-bold text-center text-white mb-6">منتجاتنا</h1>

        <div id="filter-container" class="mb-10 flex flex-col sm:flex-row gap-4 justify-center items-center">
            <input type="text" id="search-input" class="filter-input w-full sm:w-1/2 lg:w-1/3" placeholder="ابحث عن منتج...">
            <div class="flex items-center gap-2">
                <label for="category-filter" data-translate-key="filter_by_category" class="text-gray-300">حسب النوع</label>
                <select id="category-filter" class="filter-input"></select>
            </div>
        </div>

        <div id="products-grid" class="products-grid-container"></div>
        <div id="loading-indicator" class="text-center py-10">
            <p data-translate-key="loading" class="text-gray-400">جارِ تحميل المنتجات...</p>
        </div>
        <div id="no-results" class="text-center py-10 text-gray-400 hidden" data-translate-key="no_results">
            لا توجد منتجات تطابق بحثك.
        </div>
    </main>

    <script src="https://npmcdn.com/parse/dist/parse.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const translations = {
            en: {
                store_name: "Global Store", products_title: "Our Products", loading: "Loading products...", shipping_time: "Shipping Time", add_to_cart: "Add to Cart", home: "Home", syria_lebanon_store: "Syria & Lebanon Store", my_wallet: "My Wallet:", track_orders: "Track My Orders", about_us: "About Us", contact_info: "Contact Info", logout: "Logout", login: "Login", language: "Language",
                delivery_info_title: "Delivery Information", delivery_syria_lebanon: "(Map service is for Syria & Lebanon only)", fullname: "Full Name", country: "Country", city: "City", address_details: "Address Details (Street, Building...)", phone_number: "Phone Number", map_location: "Location on Map", select_on_map: "Select on Map", location_not_set: "Not Set", confirm_and_pay: "Confirm & Pay",
                detect_my_location: "Detect My Location", save_location: "Save Location", map_syria_lebanon_only: "Map delivery service is currently available for Syria and Lebanon.",
                form_field_required: "This field is required",
                tracking_modal_title: "My Orders", order_id: "Order ID", order_date: "Date", order_total: "Total", order_status: "Status",
                status_processing: "Processing", status_shipped: "Shipped", status_delivered: "Delivered", status_archived: "Archived", no_orders_yet: "You have no orders yet.",
                cart_title: "My Cart", empty_cart: "Your cart is empty.", product: "Product", price: "Price", quantity: "Quantity", total: "Total", subtotal: "Subtotal", checkout: "Checkout", pay_wallet: "Pay with Wallet", pay_paypal: "Pay with PayPal", pay_card: "Pay with Card",
                add_item_title: "Add to Cart", add_item_label: "Enter quantity", remove_item_title: "Are you sure?", remove_item_text: "This product will be removed from your cart!", remove_item_confirm: "Yes, delete it!", remove_item_cancel: "Cancel", item_removed_title: "Deleted!", item_removed_text: "The product has been removed from your cart.",
                reviews: "Reviews", write_review: "Write a Review", your_rating: "Your Rating", your_comment: "Your Comment", submit_review: "Submit Review", already_rated: "You have already rated this product.", no_reviews: "No reviews yet.",
                search_placeholder: "Search for a product...", filter_by_category: "By Category", all_categories: "All Categories", no_results: "No products match your search.",
                alert_error_title: "Error", alert_warning_title: "Warning", alert_success_title: "Success", alert_info_title: "Info",
                alert_products_load_fail: "Failed to load products. Check API keys and table permissions.",
                alert_reviews_load_fail: "Failed to load reviews.",
                alert_must_login_to_rate: "You must be logged in to rate products.",
                alert_rating_submit_success_title: "Thank you!", alert_rating_submit_success_text: "Your review has been submitted successfully.",
                alert_rating_submit_fail: "Failed to submit review.",
                alert_must_login_to_add: "Please log in first to add products to the cart.",
                alert_invalid_quantity: "Please enter a valid quantity!",
                alert_adding_to_cart: "Adding to cart...",
                alert_added_to_cart_title: "Added", alert_added_to_cart_text: "The product has been added to your cart successfully!",
                alert_add_to_cart_fail: "Failed to add product to cart.",
                alert_permission_error: "<strong>Permission Error!</strong><br>Please check the security settings for the 'Net' class.",
                alert_must_login_to_view_cart: "Please log in first to view the cart.",
                alert_loading_cart: "Loading cart...",
                alert_cart_display_fail: "Failed to display cart.",
                alert_deleting: "Deleting...",
                alert_delete_fail: "Failed to delete product.",
                alert_processing_payment: "Processing payment...",
                alert_insufficient_funds: "Your wallet balance is insufficient.",
                alert_payment_success_title: "Payment Successful!", alert_payment_success_text: "{amount} has been deducted from your wallet.",
                alert_payment_fail: "Payment process failed.",
                confirm_receipt: "Confirm Receipt", confirm_receipt_title: "Confirm Order Receipt?", confirm_receipt_text: "This order will be moved to your archive. You will no longer see it in this list.", confirm_receipt_button: "Yes, I Received It", archive_success_title: "Archived!", archive_success_text: "The order has been successfully archived.",
                label_color: "Color", label_size: "Size"
            },
            ar: {
                store_name: "المتجر العالمي", products_title: "منتجاتنا", loading: "جارِ تحميل المنتجات...", shipping_time: "وقت الشحن", add_to_cart: "أضف إلى السلة", home: "الرئيسية", syria_lebanon_store: "متجر سوريا ولبنان", my_wallet: "محفظتي:", track_orders: "تتبع طلباتي", about_us: "من نحن", contact_info: "معلومات الاتصال", logout: "تسجيل الخروج", login: "تسجيل الدخول", language: "اللغة",
                delivery_info_title: "معلومات التسليم", delivery_syria_lebanon: "(خدمة الخريطة لسوريا ولبنان فقط)", fullname: "الاسم الكامل", country: "البلد", city: "المدينة", address_details: "تفاصيل العنوان (شارع، بناء...)", phone_number: "رقم الهاتف", map_location: "الموقع على الخريطة", select_on_map: "تحديد على الخريطة", location_not_set: "لم يتم التحديد", confirm_and_pay: "تأكيد والدفع",
                detect_my_location: "تحديد موقعي", save_location: "حفظ الموقع", map_syria_lebanon_only: "خدمة التوصيل عبر الخريطة متاحة حالياً لسوريا ولبنان.",
                form_field_required: "هذا الحقل مطلوب",
                tracking_modal_title: "طلباتي", order_id: "رقم الطلب", order_date: "التاريخ", order_total: "المجموع", order_status: "الحالة",
                status_processing: "قيد المعالجة", status_shipped: "تم الشحن", status_delivered: "تم التسليم", status_archived: "مؤرشف", no_orders_yet: "لا يوجد لديك طلبات بعد.",
                cart_title: "سلتي", empty_cart: "سلتك فارغة.", product: "المنتج", price: "السعر", quantity: "الكمية", total: "المجموع", subtotal: "المجموع الفرعي", checkout: "الدفع", pay_wallet: "الدفع من المحفظة", pay_paypal: "الدفع عبر PayPal", pay_card: "الدفع بالبطاقة",
                add_item_title: "إضافة إلى السلة", add_item_label: "أدخل الكمية", remove_item_title: "هل أنت متأكد؟", remove_item_text: "سيتم حذف هذا المنتج من سلتك!", remove_item_confirm: "نعم، احذفه!", remove_item_cancel: "إلغاء", item_removed_title: "تم الحذف!", item_removed_text: "تم حذف المنتج من السلة.",
                reviews: "التقييمات", write_review: "كتابة تقييم", your_rating: "تقييمك", your_comment: "تعليقك", submit_review: "إرسال التقييم", already_rated: "لقد قمت بتقييم هذا المنتج مسبقًا.", no_reviews: "لا توجد تقييمات بعد.",
                search_placeholder: "ابحث عن منتج...", filter_by_category: "حسب النوع", all_categories: "كل الأنواع", no_results: "لا توجد منتجات تطابق بحثك.",
                alert_error_title: "خطأ", alert_warning_title: "تنبيه", alert_success_title: "نجاح", alert_info_title: "معلومة",
                alert_products_load_fail: "فشل تحميل المنتجات. تأكد من صحة مفاتيح الربط وأذونات الجدول.",
                alert_reviews_load_fail: "فشل تحميل التقييمات.",
                alert_must_login_to_rate: "يجب تسجيل الدخول لتقييم المنتجات.",
                alert_rating_submit_success_title: "شكراً لك!", alert_rating_submit_success_text: "تم إرسال تقييمك بنجاح.",
                alert_rating_submit_fail: "فشل إرسال التقييم.",
                alert_must_login_to_add: "الرجاء تسجيل الدخول أولاً لإضافة منتجات للسلة.",
                alert_invalid_quantity: "الرجاء إدخال كمية صالحة!",
                alert_adding_to_cart: "جارِ الإضافة للسلة...",
                alert_added_to_cart_title: "تمت الإضافة", alert_added_to_cart_text: "تمت إضافة المنتج إلى سلتك بنجاح!",
                alert_add_to_cart_fail: "فشلت إضافة المنتج للسلة.",
                alert_permission_error: "<strong>خطأ في الأذونات!</strong><br>الرجاء التأكد من إعدادات الأمان لجدول 'Net' بشكل صحيح.",
                alert_must_login_to_view_cart: "الرجاء تسجيل الدخول أولاً لعرض السلة.",
                alert_loading_cart: "جارِ تحميل السلة...",
                alert_cart_display_fail: "فشل عرض السلة.",
                alert_deleting: "جارِ الحذف...",
                alert_delete_fail: "فشل حذف المنتج.",
                alert_processing_payment: "جارِ معالجة الدفع...",
                alert_insufficient_funds: "رصيدك في المحفظة غير كافٍ.",
                alert_payment_success_title: "تم الدفع بنجاح!", alert_payment_success_text: "تم خصم {amount} من محفظتك.",
                alert_payment_fail: "فشلت عملية الدفع.",
                confirm_receipt: "تأكيد الاستلام", confirm_receipt_title: "تأكيد استلام الطلب؟", confirm_receipt_text: "سيتم نقل هذا الطلب إلى أرشيفك. لن يظهر مجدداً في هذه القائمة.", confirm_receipt_button: "نعم، استلمته", archive_success_title: "تمت الأرشفة!", archive_success_text: "تمت أرشفة الطلب بنجاح.",
                label_color: "اللون", label_size: "الحجم"
            },
            es: {
                store_name: "Tienda Global", products_title: "Nuestros Productos", loading: "Cargando productos...", shipping_time: "Tiempo de envío", add_to_cart: "Añadir a la Cesta", home: "Inicio", syria_lebanon_store: "Tienda de Siria y Líbano", my_wallet: "Mi Billetera:", track_orders: "Rastrear Mis Pedidos", about_us: "Sobre Nosotros", contact_info: "Contacto", logout: "Cerrar Sesión", login: "Iniciar Sesión", language: "Idioma",
                delivery_info_title: "Información de Entrega", delivery_syria_lebanon: "(Servicio de mapa solo para Siria y Líbano)", fullname: "Nombre Completo", country: "País", city: "Ciudad", address_details: "Detalles de la Dirección (Calle, Edificio...)", phone_number: "Número de Teléfono", map_location: "Ubicación en el Mapa", select_on_map: "Seleccionar en el Mapa", location_not_set: "No establecido", confirm_and_pay: "Confirmar y Pagar",
                detect_my_location: "Detectar mi Ubicación", save_location: "Guardar Ubicación", map_syria_lebanon_only: "El servicio de entrega por mapa está actualmente disponible para Siria y Líbano.",
                form_field_required: "Este campo es obligatorio",
                tracking_modal_title: "Mis Pedidos", order_id: "ID de Pedido", order_date: "Fecha", order_total: "Total", order_status: "Estado",
                status_processing: "Procesando", status_shipped: "Enviado", status_delivered: "Entregado", status_archived: "Archivado", no_orders_yet: "Aún no tienes pedidos.",
                cart_title: "Mi Cesta", empty_cart: "Tu cesta está vacía.", product: "Producto", price: "Precio", quantity: "Cantidad", total: "Total", subtotal: "Subtotal", checkout: "Pagar", pay_wallet: "Pagar con Billetera", pay_paypal: "Pagar con PayPal", pay_card: "Pagar con Tarjeta",
                add_item_title: "Añadir a la Cesta", add_item_label: "Introduzca la cantidad", remove_item_title: "¿Estás seguro?", remove_item_text: "¡Este producto será eliminado de tu cesta!", remove_item_confirm: "¡Sí, bórralo!", remove_item_cancel: "Cancelar", item_removed_title: "¡Eliminado!", item_removed_text: "El producto ha sido eliminado de tu cesta.",
                reviews: "Reseñas", write_review: "Escribir una reseña", your_rating: "Tu valoración", your_comment: "Tu comentario", submit_review: "Enviar Reseña", already_rated: "Ya has valorado este producto.", no_reviews: "Aún no hay reseñas.",
                search_placeholder: "Buscar un producto...", filter_by_category: "Por Categoría", all_categories: "Todas las Categorías", no_results: "No hay productos que coincidan con tu búsqueda.",
                alert_error_title: "Error", alert_warning_title: "Advertencia", alert_success_title: "Éxito", alert_info_title: "Información",
                alert_products_load_fail: "No se pudieron cargar los productos. Verifique las claves de API y los permisos de la tabla.",
                alert_reviews_load_fail: "No se pudieron cargar las reseñas.",
                alert_must_login_to_rate: "Debes iniciar sesión para valorar productos.",
                alert_rating_submit_success_title: "¡Gracias!", alert_rating_submit_success_text: "Tu reseña ha sido enviada con éxito.",
                alert_rating_submit_fail: "Error al enviar la reseña.",
                alert_must_login_to_add: "Por favor, inicie sesión primero para añadir productos a la cesta.",
                alert_invalid_quantity: "¡Por favor, introduzca una cantidad válida!",
                alert_adding_to_cart: "Añadiendo a la cesta...",
                alert_added_to_cart_title: "Añadido", alert_added_to_cart_text: "¡El producto ha sido añadido a tu cesta con éxito!",
                alert_add_to_cart_fail: "Error al añadir el producto a la cesta.",
                alert_permission_error: "<strong>¡Error de Permiso!</strong><br>Por favor, compruebe la configuración de seguridad para la clase 'Net'.",
                alert_must_login_to_view_cart: "Por favor, inicie sesión primero para ver la cesta.",
                alert_loading_cart: "Cargando cesta...",
                alert_cart_display_fail: "Error al mostrar la cesta.",
                alert_deleting: "Eliminando...",
                alert_delete_fail: "Error al eliminar el producto.",
                alert_processing_payment: "Procesando pago...",
                alert_insufficient_funds: "El saldo de su billetera es insuficiente.",
                alert_payment_success_title: "¡Pago Exitoso!", alert_payment_success_text: "Se ha deducido {amount} de su billetera.",
                alert_payment_fail: "El proceso de pago falló.",
                confirm_receipt: "Confirmar Recibo", confirm_receipt_title: "¿Confirmar la recepción del pedido?", confirm_receipt_text: "Este pedido se moverá a su archivo. Ya no lo verá en esta lista.", confirm_receipt_button: "Sí, lo recibí", archive_success_title: "¡Archivado!", archive_success_text: "El pedido se ha archivado con éxito.",
                label_color: "Color", label_size: "Tamaño"
            }
        };
        
        const countryList = [ "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda", "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cabo Verde", "Cambodia", "Cameroon", "Canada", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo, Democratic Republic of the", "Congo, Republic of the", "Costa Rica", "Cote d'Ivoire", "Croatia", "Cuba", "Cyprus", "Czechia", "Denmark", "Djibouti", "Dominica", "Dominican Republic", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia", "Fiji", "Finland", "France", "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti", "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati", "Kosovo", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg", "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania", "Mauritius", "Mexico", "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia", "Nauru", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Korea", "North Macedonia", "Norway", "Oman", "Pakistan", "Palau", "Palestine State", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal", "Qatar", "Romania", "Russia", "Rwanda", "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Sao Tome and Principe", "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia", "South Africa", "South Korea", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria", "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Timor-Leste", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan", "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States of America", "Uruguay", "Uzbekistan", "Vanuatu", "Vatican City", "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabwe"];

        let currentLang = 'ar';
        Parse.initialize("a10tYxDiUFIaigtshCBuVOjYvqkUedYrS2bbwxV7", "LW1t1PMFgqMJqwiwe78vvgN9mvkxP1LuhbxGNLUY");
        Parse.serverURL = "https://parseapi.back4app.com/";
        const currentUser = Parse.User.current();

        let productsCache = [];
        let uniqueCategories = [];
        let deliveryLocation = null;

        const searchInput = document.getElementById('search-input');
        const categoryFilter = document.getElementById('category-filter');
        const noResultsDiv = document.getElementById('no-results');
        
        // --- START OF ALL FUNCTIONS ---

        function setLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.getAttribute('data-translate-key');
                if (translations[lang] && translations[lang][key]) {
                     if (key === 'my_wallet') {
                        const balanceSpan = el.querySelector('#wallet-balance, #wallet-balance-mobile');
                        el.textContent = translations[lang][key] + ' ';
                        if (balanceSpan) el.appendChild(balanceSpan);
                    } else {
                        el.textContent = translations[lang][key];
                    }
                }
            });
            searchInput.placeholder = translations[lang].search_placeholder;
            populateCategoryFilter(lang);
            applyFiltersAndRender();
        }

        async function fetchProducts() {
            const loadingIndicator = document.getElementById('loading-indicator');
            const productsGrid = document.getElementById('products-grid');
            loadingIndicator.style.display = 'block';
            productsGrid.innerHTML = '';
            // -- تعديل --: استهداف جدول Things
            const Product = Parse.Object.extend("Things");
            const query = new Parse.Query(Product);
            // -- تعديل --: جلب كل الحقول الجديدة
            query.select(
                "name_ar", "name_en", "name_es", "description_ar", "description_en", "description_es", 
                "category_ar", "category_en", "category_es", "price", "imageFile", "photos", 
                "shippingTime", "averageRating", "ratingCount", 
                "availableColors", "availableSizes", "img1", "img2", "img3"
            );
            try {
                const products = await query.find();
                productsCache = products;
                const categoryMap = new Map();
                productsCache.forEach(p => {
                    const cat_en = p.get('category_en');
                    if (cat_en && !categoryMap.has(cat_en)) {
                        categoryMap.set(cat_en, {
                            en: cat_en, ar: p.get('category_ar'), es: p.get('category_es')
                        });
                    }
                });
                uniqueCategories = Array.from(categoryMap.values());
                populateCategoryFilter(currentLang);
                applyFiltersAndRender();
            } catch (error) {
                console.error("Error fetching products: ", error);
                Swal.fire({
                    title: translations[currentLang].alert_error_title,
                    html: `${translations[currentLang].alert_products_load_fail}<br><code class="text-xs">${error.message}</code>`,
                    icon: 'error'
                });
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        function populateCategoryFilter(lang) {
            const selectedValue = categoryFilter.value;
            categoryFilter.innerHTML = '';
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = translations[lang].all_categories;
            categoryFilter.appendChild(allOption);
            uniqueCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.en;
                option.textContent = cat[lang] || cat.en;
                categoryFilter.appendChild(option);
            });
            categoryFilter.value = selectedValue || 'all';
        }

        function applyFiltersAndRender() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const selectedCategory = categoryFilter.value;
            let filteredProducts = productsCache;
            if (searchTerm) {
                filteredProducts = filteredProducts.filter(product => {
                    const name = product.get(`name_${currentLang}`) || '';
                    return name.toLowerCase().includes(searchTerm);
                });
            }
            if (selectedCategory !== 'all') {
                filteredProducts = filteredProducts.filter(product => product.get('category_en') === selectedCategory);
            }
            renderProducts(filteredProducts, currentLang);
        }

        function renderProducts(products, lang) {
            const productsGrid = document.getElementById('products-grid');
            productsGrid.innerHTML = '';
            noResultsDiv.style.display = products.length === 0 ? 'block' : 'none';
            for (const product of products) {
                const name = product.get(`name_${lang}`) || 'Product Name';
                const category = product.get(`category_${lang}`) || 'Collection';
                const price = product.get('price') || 0;
                const imageFile = product.get('imageFile');
                const imageUrl = imageFile ? imageFile.url() : 'https://via.placeholder.com/220';
                const shippingTime = product.get('shippingTime') || '—';
                const averageRating = Math.round(product.get('averageRating') || 0);
                const ratingCount = product.get('ratingCount') || 0;
                let starsHTML = '';
                for (let i = 1; i <= 5; i++) {
                    starsHTML += `<i class="fa-solid fa-star ${i <= averageRating ? 'text-yellow-400' : 'text-gray-300'}"></i>`;
                }
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-head"><img src="${imageUrl}" alt="${name}" class="product-img"></div>
                    <div class="card-body">
                        <div class="product-desc">
                            <span class="product-title">${name}</span>
                            <span class="product-caption">${category}</span>
                            <div class="product-rating mt-2 flex items-center" dir="ltr">${starsHTML}<span class="text-xs text-gray-500 ml-2">(${ratingCount})</span></div>
                            <p class="product-caption mt-1">${translations[lang].shipping_time}: ${shippingTime}</p>
                        </div>
                        <div class="product-properties mt-2">
                            <span class="product-price">$<b>${price.toFixed(2)}</b></span>
                            <button class="add-to-cart-btn bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition" data-product-id="${product.id}">${translations[lang].add_to_cart}</button>
                        </div>
                    </div>`;
                card.querySelector('.add-to-cart-btn').addEventListener('click', e => { e.stopPropagation(); showProductDetails(product); });
                card.addEventListener('click', () => showProductDetails(product));
                productsGrid.appendChild(card);
            }
        }

        async function fetchUserWallet() {
            try {
                const user = await currentUser.fetch();
                const balance = user.get('walletBalance') || 0;
                const formattedBalance = `$${balance.toFixed(2)}`;
                document.getElementById('wallet-balance').textContent = formattedBalance;
                document.getElementById('wallet-balance-mobile').textContent = formattedBalance;
            } catch (error) {
                console.error("Error fetching wallet:", error);
                document.getElementById('wallet-balance').textContent = '$0.00';
                document.getElementById('wallet-balance-mobile').textContent = '$0.00';
            }
        }

        // -- تعديل --: تم استبدال هذه الدالة بالكامل لتضمين كل الميزات الجديدة
        async function showProductDetails(product) {
            if (!product) return;
            const name = product.get(`name_${currentLang}`);
            const description = product.get(`description_${currentLang}`);
            const price = product.get('price');
            
            const mainImageFile = product.get('imageFile');
            const mainImageUrl = mainImageFile ? mainImageFile.url() : 'https://via.placeholder.com/220';

            const allImages = [];
            if (mainImageFile) allImages.push(mainImageFile);
            const img1 = product.get('img1');
            const img2 = product.get('img2');
            const img3 = product.get('img3');
            if (img1) allImages.push(img1);
            if (img2) allImages.push(img2);
            if (img3) allImages.push(img3);
            const photosArray = product.get('photos') || [];
            if (Array.isArray(photosArray)) {
                photosArray.forEach(photo => allImages.push(photo));
            }

            let thumbnailsHTML = '';
            allImages.forEach(imgFile => {
                if (imgFile && typeof imgFile.url === 'function') {
                    thumbnailsHTML += `<img src="${imgFile.url()}" class="thumbnail-img w-16 h-16 object-cover cursor-pointer border-2 border-transparent hover:border-blue-500 rounded-md">`;
                }
            });

            const availableColors = product.get('availableColors') || [];
            const availableSizes = product.get('availableSizes') || [];
            let optionsHTML = '';
            if (availableColors.length > 0) {
                optionsHTML += `
                <div class="mt-4">
                    <label for="color-select" class="block mb-2 text-sm font-bold text-gray-700">${translations[currentLang].label_color}:</label>
                    <select id="color-select" class="w-full p-2 border rounded-md text-gray-800">${availableColors.map(c => `<option value="${c}">${c}</option>`).join('')}</select>
                </div>`;
            }
            if (availableSizes.length > 0) {
                optionsHTML += `
                <div class="mt-4">
                    <label for="size-select" class="block mb-2 text-sm font-bold text-gray-700">${translations[currentLang].label_size}:</label>
                    <select id="size-select" class="w-full p-2 border rounded-md text-gray-800">${availableSizes.map(s => `<option value="${s}">${s}</option>`).join('')}</select>
                </div>`;
            }

            const Ratings = Parse.Object.extend("Ratings");
            const query = new Parse.Query(Ratings);
            query.equalTo("product", product); // استهداف حقل "product" الصحيح
            query.include("guest");
            query.descending("createdAt");
            let reviewsHTML = `<div class="mt-8 pt-4 border-t border-gray-200"><h3 class="font-bold text-lg mb-2 text-gray-800">${translations[currentLang].reviews}</h3><div id="reviews-list" class="max-h-48 overflow-y-auto space-y-4">`;
            try {
                const reviews = await query.find();
                if (reviews.length === 0) {
                    reviewsHTML += `<p class="text-gray-500">${translations[currentLang].no_reviews}</p>`;
                } else {
                    reviews.forEach(review => {
                        const user = review.get("guest");
                        const username = user ? (user.get("name") || user.get("username")) : "مستخدم";
                        const stars = review.get("stars");
                        const comment = review.get("comment");
                        let reviewStars = '';
                        for (let i = 1; i <= 5; i++) { reviewStars += `<i class="fa-solid fa-star ${i <= stars ? 'text-yellow-400' : 'text-gray-300'}"></i>`; }
                        reviewsHTML += `<div class="p-3 bg-gray-100 rounded-lg"><p class="font-semibold text-gray-800">${username}</p><div class="my-1" dir="ltr">${reviewStars}</div><p class="text-gray-700">${comment}</p></div>`;
                    });
                }
            } catch(e) {
                reviewsHTML += `<p class="text-red-500">${translations[currentLang].alert_reviews_load_fail}</p>`;
            }
            reviewsHTML += `</div></div>`;
            
            const modalHTML = `
            <div class="flex flex-col md:flex-row gap-6">
                <div class="md:w-1/2">
                    <img id="main-product-image" src="${mainImageUrl}" class="w-full rounded-lg mb-4 h-80 object-contain">
                    <div class="flex gap-2 justify-center flex-wrap">${thumbnailsHTML}</div>
                </div>
                <div class="md:w-1/2 text-right">
                    <h2 class="text-3xl font-bold mb-2 text-gray-800">${name}</h2>
                    <div class="text-gray-600 mb-4">${description || ''}</div>
                    <p class="text-3xl font-bold text-blue-600 my-6">$${price.toFixed(2)}</p>
                    ${optionsHTML}
                    <button id="add-to-cart-modal-btn" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 mt-6">${translations[currentLang].add_to_cart}</button>
                    <button id="write-review-btn" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 mt-2">${translations[currentLang].write_review}</button>
                </div>
            </div>` + reviewsHTML;

            Swal.fire({
                html: modalHTML,
                width: '800px',
                showConfirmButton: false,
                showCloseButton: true,
                didOpen: () => {
                    const mainImage = document.getElementById('main-product-image');
                    document.querySelectorAll('.thumbnail-img').forEach(thumb => {
                        thumb.addEventListener('click', () => { mainImage.src = thumb.src; });
                    });
                    document.getElementById('write-review-btn').addEventListener('click', () => promptForReview(product));
                    document.getElementById('add-to-cart-modal-btn').addEventListener('click', () => {
                        const selectedColor = document.getElementById('color-select')?.value;
                        const selectedSize = document.getElementById('size-select')?.value;
                        promptForQuantity(product, selectedColor, selectedSize);
                    });
                }
            });
        }

        async function promptForReview(product) {
            if(!currentUser) { Swal.fire(translations[currentLang].alert_warning_title, translations[currentLang].alert_must_login_to_rate, 'warning'); return; }
            const Ratings = Parse.Object.extend("Ratings");
            const query = new Parse.Query(Ratings);
            query.equalTo("product", product); // استهداف حقل "product" الصحيح
            query.equalTo("guest", currentUser);
            const existingRating = await query.first();
            if (existingRating) { Swal.fire(translations[currentLang].alert_info_title, translations[currentLang].already_rated, 'info'); return; }
            const { value: formValues } = await Swal.fire({
                title: translations[currentLang].write_review,
                html: `<div class="rating-stars text-3xl mb-4"><i class="fa fa-star text-gray-400" data-value="1"></i><i class="fa fa-star text-gray-400" data-value="2"></i><i class="fa fa-star text-gray-400" data-value="3"></i><i class="fa fa-star text-gray-400" data-value="4"></i><i class="fa fa-star text-gray-400" data-value="5"></i></div><textarea id="swal-comment" class="swal2-textarea" placeholder="${translations[currentLang].your_comment}"></textarea>`,
                focusConfirm: false,
                confirmButtonText: translations[currentLang].submit_review,
                showCancelButton: true,
                cancelButtonText: translations[currentLang].remove_item_cancel,
                preConfirm: () => { return { stars: document.querySelector('.rating-stars').dataset.rating || 0, comment: document.getElementById('swal-comment').value } },
                didOpen: () => {
                    const stars = document.querySelectorAll('.rating-stars .fa-star');
                    stars.forEach(star => {
                        star.addEventListener('mouseover', (e) => { const rating = parseInt(e.target.dataset.value); stars.forEach((s, i) => s.classList.toggle('text-yellow-400', i < rating)); });
                        star.addEventListener('mouseout', () => { const currentRating = parseInt(document.querySelector('.rating-stars').dataset.rating || 0); stars.forEach((s, i) => s.classList.toggle('text-yellow-400', i < currentRating)); });
                        star.addEventListener('click', (e) => { const rating = parseInt(e.target.dataset.value); document.querySelector('.rating-stars').dataset.rating = rating; });
                    });
                }
            });
            if (formValues && formValues.stars > 0) {
                const Rating = Parse.Object.extend("Ratings");
                const newRating = new Rating();
                newRating.set("stars", parseInt(formValues.stars));
                newRating.set("comment", formValues.comment);
                newRating.set("product", product); // استهداف حقل "product" الصحيح
                newRating.set("guest", currentUser);
                try {
                    await newRating.save();
                    Swal.fire(translations[currentLang].alert_rating_submit_success_title, translations[currentLang].alert_rating_submit_success_text, 'success').then(() => fetchProducts());
                } catch(error) { Swal.fire(translations[currentLang].alert_error_title, translations[currentLang].alert_rating_submit_fail, 'error'); }
            }
        }

        // -- تعديل --: الدالة الآن تقبل اللون والحجم
        async function promptForQuantity(product, selectedColor, selectedSize) {
            if(!currentUser) { Swal.fire(translations[currentLang].alert_warning_title, translations[currentLang].alert_must_login_to_add, 'warning'); return; }
            const { value: quantity } = await Swal.fire({
                title: translations[currentLang].add_item_title,
                input: 'number',
                inputLabel: translations[currentLang].add_item_label,
                inputValue: 1,
                inputAttributes: { min: 1, step: 1 },
                showCancelButton: true,
                confirmButtonText: translations[currentLang].add_to_cart,
                cancelButtonText: translations[currentLang].remove_item_cancel,
                inputValidator: (value) => { if (!value || value < 1) { return translations[currentLang].alert_invalid_quantity } }
            });
            if (quantity) { addToCart(product, parseInt(quantity), selectedColor, selectedSize); }
        }

        // -- تعديل --: الدالة الآن تحفظ اللون والحجم
        async function addToCart(product, quantityToAdd, selectedColor, selectedSize) {
            Swal.fire({ title: translations[currentLang].alert_adding_to_cart, allowOutsideClick: false, didOpen: () => { Swal.showLoading(); }});
            const Net = Parse.Object.extend("Net");
            const query = new Parse.Query(Net);
            query.equalTo("guest", currentUser);
            query.equalTo("product", product); // استهداف حقل "product" الصحيح

            if (selectedColor) {
                query.equalTo("selectedColor", selectedColor);
            } else {
                query.doesNotExist("selectedColor");
            }
            if (selectedSize) {
                query.equalTo("selectedSize", selectedSize);
            } else {
                query.doesNotExist("selectedSize");
            }

            try {
                let cartItem = await query.first();
                if (cartItem) { cartItem.increment("quantity", quantityToAdd); }
                else { 
                    cartItem = new Net(); 
                    cartItem.set("guest", currentUser); 
                    cartItem.set("product", product); // استهداف حقل "product" الصحيح
                    cartItem.set("quantity", quantityToAdd);
                    if (selectedColor) cartItem.set("selectedColor", selectedColor);
                    if (selectedSize) cartItem.set("selectedSize", selectedSize);
                }
                await cartItem.save();
                updateCartCount();
                Swal.fire(translations[currentLang].alert_added_to_cart_title, translations[currentLang].alert_added_to_cart_text, 'success');
            } catch (error) {
                 console.error("Error adding to cart:", error);
                 let errorMessage = translations[currentLang].alert_add_to_cart_fail;
                 if (error.code === 119) { errorMessage = translations[currentLang].alert_permission_error; }
                 Swal.fire({ title: translations[currentLang].alert_error_title, html: errorMessage + `<br><br><code class="text-xs text-left block" dir="ltr">${error.message}</code>`, icon: 'error' });
            }
        }

        async function updateCartCount() {
            if(!currentUser) return;
            const Net = Parse.Object.extend("Net");
            const query = new Parse.Query(Net);
            query.equalTo("guest", currentUser);
            try {
                const cartItems = await query.find();
                const totalItems = cartItems.reduce((sum, item) => sum + item.get('quantity'), 0);
                if(totalItems > 0) {
                    document.getElementById('cart-count').textContent = totalItems;
                    document.getElementById('cart-count').classList.remove('hidden');
                } else {
                    document.getElementById('cart-count').classList.add('hidden');
                }
            } catch (error) { console.error("Error updating cart count:", error); }
        }

        // -- تعديل --: الدالة الآن تعرض اللون والحجم
        async function showCartModal() {
            const Net = Parse.Object.extend("Net");
            const query = new Parse.Query(Net);
            query.equalTo("guest", currentUser);
            query.include("product");
            query.include("productsy");
            Swal.fire({ title: translations[currentLang].alert_loading_cart, allowOutsideClick: false, didOpen: () => { Swal.showLoading(); }});
            try {
                const cartItems = await query.find();
                let subtotal = 0;
                let cartHTML;
                if (cartItems.length === 0) {
                    cartHTML = `<p class="text-center p-4">${translations[currentLang].empty_cart}</p>`;
                } else {
                    cartHTML = `<div class="max-h-64 overflow-y-auto"><table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0"><tr>
                        <th scope="col" class="px-4 py-3">${translations[currentLang].product}</th>
                        <th scope="col" class="px-4 py-3">${translations[currentLang].quantity}</th>
                        <th scope="col" class="px-4 py-3">${translations[currentLang].total}</th>
                        <th scope="col" class="px-2 py-3"></th>
                    </tr></thead><tbody>`;
                    cartItems.forEach(item => {
                        const productObject = item.get("product") || item.get("productsy");
                        if (!productObject) return;
                        const price = productObject.get("price") || 0;
                        const quantity = item.get("quantity");
                        const total = price * quantity;
                        subtotal += total;

                        const color = item.get("selectedColor");
                        const size = item.get("selectedSize");
                        let detailsHTML = '';
                        if (color || size) {
                            const colorText = color ? `${translations[currentLang].label_color}: ${color}` : '';
                            const sizeText = size ? `${translations[currentLang].label_size}: ${size}` : '';
                            detailsHTML = `<span class="text-xs text-gray-500 block">${colorText} ${sizeText}</span>`;
                        }

                        cartHTML += `<tr class="bg-white border-b"><td class="px-6 py-4 font-medium text-gray-900">${productObject.get(`name_${currentLang}`)} ${detailsHTML}</td><td class="px-6 py-4">${quantity}</td><td class="px-6 py-4">$${total.toFixed(2)}</td><td class="px-2 py-4 text-center"><button class="remove-from-cart-btn text-red-500 hover:text-red-700" data-cart-item-id="${item.id}"><i class="fas fa-trash-alt"></i></button></td></tr>`;
                    });
                    cartHTML += `</tbody></table></div>`;
                }
                const footerHTML = `<div class="mt-6 text-right"><p class="text-lg">${translations[currentLang].subtotal}: <span class="font-bold text-xl text-blue-600">$${subtotal.toFixed(2)}</span></p></div><div class="mt-4 border-t pt-4"><h3 class="font-bold mb-2">${translations[currentLang].checkout}</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-2"><button id="pay-wallet-btn" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition">${translations[currentLang].pay_wallet}</button><button class="bg-yellow-500 text-white p-2 rounded-lg hover:bg-yellow-600 transition" disabled>${translations[currentLang].pay_paypal}</button><button class="bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 transition" disabled>${translations[currentLang].pay_card}</button></div></div>`;
                Swal.fire({
                    title: translations[currentLang].cart_title, html: cartHTML + footerHTML, width: '800px', showConfirmButton: false, showCloseButton: true,
                    didOpen: () => {
                        const payWalletBtn = document.getElementById('pay-wallet-btn');
                        if (payWalletBtn && cartItems.length > 0) {
                            payWalletBtn.addEventListener('click', () => promptForDeliveryInfo(subtotal, cartItems));
                        }
                        document.querySelectorAll('.remove-from-cart-btn').forEach(btn => btn.addEventListener('click', (e) => confirmRemoveFromCart(e.currentTarget.dataset.cartItemId)));
                    }
                });
            } catch (error) {
                console.error("Error showing cart:", error);
                Swal.fire(translations[currentLang].alert_error_title, translations[currentLang].alert_cart_display_fail, 'error');
            }
        }
        
        function promptForDeliveryInfo(totalCost, cartItems, prefillData = {}) {
            deliveryLocation = prefillData.deliveryLocation || null;
            const formHTML = `
                <div id="delivery-form" class="text-left text-gray-800 p-2" dir="${currentLang === 'ar' ? 'rtl' : 'ltr'}">
                    <label class="font-bold">${translations[currentLang].fullname}:</label>
                    <input type="text" id="fullname" class="delivery-form-input" required>
                    <label class="font-bold mt-2 block">${translations[currentLang].country}:</label>
                    <select id="country" class="delivery-form-input"></select>
                    <label class="font-bold mt-2 block">${translations[currentLang].city}:</label>
                    <input type="text" id="city" class="delivery-form-input" required>
                    <label class="font-bold mt-2 block">${translations[currentLang].address_details}:</label>
                    <input type="text" id="address" class="delivery-form-input" required>
                    <label class="font-bold mt-2 block">${translations[currentLang].phone_number}:</label>
                    <input type="tel" id="phone" class="delivery-form-input" required>
                    <label class="font-bold mt-4 block">${translations[currentLang].map_location}: <span class="text-sm font-normal text-gray-500">${translations[currentLang].delivery_syria_lebanon}</span></label>
                    <div class="flex items-center gap-4 mt-1">
                        <button id="select-on-map-btn" type="button" class="bg-blue-500 text-white py-1 px-3 rounded">${translations[currentLang].select_on_map}</button>
                        <span id="location-display" class="text-sm text-gray-600">${translations[currentLang].location_not_set}</span>
                    </div>
                </div>`;

            Swal.fire({
                title: translations[currentLang].delivery_info_title,
                html: formHTML,
                confirmButtonText: translations[currentLang].confirm_and_pay,
                showCancelButton: true,
                cancelButtonText: translations[currentLang].remove_item_cancel,
                customClass: { popup: 'w-full max-w-lg' },
                didOpen: () => {
                    const countryDropdown = document.getElementById('country');
                    countryList.forEach(countryName => {
                        const option = document.createElement('option');
                        option.value = countryName;
                        option.textContent = countryName;
                        countryDropdown.appendChild(option);
                    });
                    
                    document.getElementById('fullname').value = prefillData.fullname || '';
                    countryDropdown.value = prefillData.country || 'Syria';
                    document.getElementById('city').value = prefillData.city || '';
                    document.getElementById('address').value = prefillData.address || '';
                    document.getElementById('phone').value = prefillData.phone || '';
                    
                    if (deliveryLocation) {
                        document.getElementById('location-display').textContent = `${deliveryLocation.lat.toFixed(4)}, ${deliveryLocation.lng.toFixed(4)}`;
                    }

                    document.getElementById('select-on-map-btn').addEventListener('click', () => {
                        const currentData = {
                            fullname: document.getElementById('fullname').value,
                            country: document.getElementById('country').value,
                            city: document.getElementById('city').value,
                            address: document.getElementById('address').value,
                            phone: document.getElementById('phone').value,
                            deliveryLocation: deliveryLocation
                        };
                        showMapModal(totalCost, cartItems, currentData);
                    });
                },
                preConfirm: () => {
                    const fullname = document.getElementById('fullname').value.trim();
                    const country = document.getElementById('country').value.trim();
                    const city = document.getElementById('city').value.trim();
                    const address = document.getElementById('address').value.trim();
                    const phone = document.getElementById('phone').value.trim();
                    if (!fullname || !city || !address || !phone) {
                        Swal.showValidationMessage(translations[currentLang].form_field_required);
                        return false;
                    }
                    const shippingDetails = { fullname, country, city, address, phone };
                    return { shippingDetails, deliveryLocation, totalCost, cartItems };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const { shippingDetails, deliveryLocation, totalCost, cartItems } = result.value;
                    processOrder(totalCost, cartItems, shippingDetails, deliveryLocation);
                }
            });
        }
        
        function showMapModal(totalCost, cartItems, currentData) {
            Swal.fire({
                title: translations[currentLang].select_on_map,
                html: `<div class="text-center text-gray-800">
                    <p class="text-sm text-gray-500 mb-2">${translations[currentLang].map_syria_lebanon_only}</p>
                    <div id="map"></div>
                    <div class="mt-4 flex gap-4 justify-center">
                        <button id="detect-location-btn" class="bg-blue-500 text-white py-2 px-4 rounded"><i class="fas fa-location-arrow mr-2"></i>${translations[currentLang].detect_my_location}</button>
                        <button id="save-location-btn" class="bg-green-500 text-white py-2 px-4 rounded">${translations[currentLang].save_location}</button>
                    </div>
                </div>`,
                width: '90%',
                maxWidth: '700px',
                showConfirmButton: false,
                showCancelButton: true,
                didOpen: () => {
                    let map = L.map('map').setView([33.5138, 36.2765], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                    let marker;
                    
                    if (currentData.deliveryLocation) {
                        marker = L.marker([currentData.deliveryLocation.lat, currentData.deliveryLocation.lng]).addTo(map);
                        map.setView([currentData.deliveryLocation.lat, currentData.deliveryLocation.lng], 15);
                    }

                    function placeMarker(lat, lng) {
                        if (marker) map.removeLayer(marker);
                        marker = L.marker([lat, lng]).addTo(map);
                        deliveryLocation = { lat, lng };
                        map.setView([lat, lng], 15);
                    }

                    map.on('click', e => placeMarker(e.latlng.lat, e.latlng.lng));
                    
                    document.getElementById('save-location-btn').addEventListener('click', () => {
                        Swal.close();
                    });

                    document.getElementById('detect-location-btn').addEventListener('click', () => {
                        if (navigator.geolocation) {
                            const options = { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 };
                            navigator.geolocation.getCurrentPosition(
                                (position) => placeMarker(position.coords.latitude, position.coords.longitude),
                                () => { alert('Could not get your location.'); },
                                options
                            );
                        } else { alert('Geolocation is not supported by this browser.'); }
                    });
                }
            }).then(() => {
                promptForDeliveryInfo(totalCost, cartItems, currentData);
            });
        }
        
        // -- تعديل --: الدالة الآن تحفظ اللون والحجم في الطلب
        async function processOrder(totalCost, cartItems, shippingDetails, location) {
            Swal.fire({ title: translations[currentLang].alert_processing_payment, allowOutsideClick: false, didOpen: () => { Swal.showLoading() } });
            try {
                const user = await currentUser.fetch();
                const balance = user.get('walletBalance') || 0;
                if (balance < totalCost) {
                    Swal.fire(translations[currentLang].alert_error_title, translations[currentLang].alert_insufficient_funds, 'error');
                    return;
                }
                const Order = Parse.Object.extend("Orders");
                const order = new Order();
                const itemsSnapshot = cartItems.map(item => {
                    const productObject = item.get("product") || item.get("productsy");
                    return { 
                        objectId: productObject.id, 
                        name: productObject.get(`name_en`), 
                        quantity: item.get("quantity"), 
                        price: productObject.get("price"),
                        color: item.get("selectedColor") || 'N/A',
                        size: item.get("selectedSize") || 'N/A'
                    };
                });
                order.set("customer", currentUser);
                order.set("shippingDetails", shippingDetails);
                if (location) { order.set("shippingLocation", new Parse.GeoPoint(location.lat, location.lng)); }
                order.set("items", itemsSnapshot);
                order.set("totalAmount", totalCost);
                order.set("status", "Processing");
                await order.save();
                const newBalance = balance - totalCost;
                currentUser.set('walletBalance', newBalance);
                await currentUser.save();
                await Parse.Object.destroyAll(cartItems);
                fetchUserWallet();
                updateCartCount();
                const amount = `$${totalCost.toFixed(2)}`;
                const successText = translations[currentLang].alert_payment_success_text.replace('{amount}', amount);
                await Swal.fire(translations[currentLang].alert_payment_success_title, successText, 'success');
                showCartModal();
            } catch (error) {
                console.error("Error during order processing:", error);
                Swal.fire(translations[currentLang].alert_error_title, translations[currentLang].alert_payment_fail, 'error');
            }
        }

        async function showTrackingModal() {
            if (!currentUser) {
                Swal.fire(translations[currentLang].alert_warning_title, translations[currentLang].alert_must_login_to_view_cart, 'warning');
                return;
            }
            Swal.fire({ title: translations[currentLang].loading, allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            const Order = Parse.Object.extend("Orders");
            const query = new Parse.Query(Order);
            query.equalTo("customer", currentUser);
            query.notEqualTo("status", "Archived");
            query.descending("createdAt");
            try {
                const orders = await query.find();
                let ordersHTML;
                if (orders.length === 0) {
                    ordersHTML = `<p class="text-center text-gray-600 p-4">${translations[currentLang].no_orders_yet}</p>`;
                } else {
                    ordersHTML = '<div class="space-y-4 text-left">';
                    orders.forEach(order => {
                        const status = order.get('status');
                        const statusKey = `status_${status.toLowerCase()}`;
                        const statusText = translations[currentLang][statusKey] || status;
                        let statusColor = 'bg-gray-500';
                        if (status === 'Processing') statusColor = 'bg-yellow-500';
                        if (status === 'Shipped') statusColor = 'bg-blue-500';
                        if (status === 'Delivered') statusColor = 'bg-green-500';
                        let confirmButtonHTML = '';
                        if (status === 'Delivered') {
                            confirmButtonHTML = `<div class="mt-3 text-right">
                                <button class="confirm-receipt-btn bg-indigo-600 text-white py-1 px-3 rounded-md text-sm hover:bg-indigo-700 transition" data-order-id="${order.id}">
                                    <i class="fas fa-check-double mr-1"></i>
                                    ${translations[currentLang].confirm_receipt}
                                </button>
                            </div>`;
                        }
                        ordersHTML += `
                        <div class="border rounded-lg p-4 bg-white text-gray-800" dir="${currentLang === 'ar' ? 'rtl' : 'ltr'}">
                            <div class="flex justify-between items-center">
                                <p class="font-bold">${translations[currentLang].order_id}: <span class="font-normal">${order.id}</span></p>
                                <span class="status-badge ${statusColor}">${statusText}</span>
                            </div>
                            <p class="text-sm text-gray-600">${translations[currentLang].order_date}: ${new Date(order.get('createdAt')).toLocaleDateString()}</p>
                            <p class="text-sm text-gray-600">${translations[currentLang].order_total}: <span class="font-bold">$${order.get('totalAmount').toFixed(2)}</span></p>
                            ${confirmButtonHTML}
                        </div>`;
                    });
                    ordersHTML += '</div>';
                }
                Swal.fire({
                    title: translations[currentLang].tracking_modal_title,
                    html: ordersHTML, width: '90%', maxWidth: '600px',
                    showConfirmButton: false, showCloseButton: true, background: '#f9fafb',
                    didOpen: () => {
                        document.querySelectorAll('.confirm-receipt-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const orderId = e.currentTarget.dataset.orderId;
                                confirmOrderReceiptAndArchive(orderId);
                            });
                        });
                    }
                });
            } catch (error) {
                console.error("Error fetching orders:", error);
                Swal.fire(translations[currentLang].alert_error_title, "Failed to fetch orders.", 'error');
            }
        }
        
        async function confirmOrderReceiptAndArchive(orderId) {
            const result = await Swal.fire({
                title: translations[currentLang].confirm_receipt_title,
                text: translations[currentLang].confirm_receipt_text,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: translations[currentLang].confirm_receipt_button,
                cancelButtonText: translations[currentLang].remove_item_cancel
            });
            if (result.isConfirmed) {
                Swal.fire({ title: translations[currentLang].loading, allowOutsideClick: false, didOpen: () => { Swal.showLoading(); }});
                const Order = Parse.Object.extend("Orders");
                const query = new Parse.Query(Order);
                try {
                    const order = await query.get(orderId);
                    order.set("status", "Archived"); 
                    await order.save();
                    await Swal.fire(
                        translations[currentLang].archive_success_title,
                        translations[currentLang].archive_success_text,
                        'success'
                    );
                    showTrackingModal();
                } catch (error) {
                    console.error("Error archiving order:", error);
                    Swal.fire(translations[currentLang].alert_error_title,"Failed to archive the order.",'error');
                }
            }
        }
        
        async function confirmRemoveFromCart(cartItemId) {
            const result = await Swal.fire({
                title: translations[currentLang].remove_item_title,
                text: translations[currentLang].remove_item_text,
                icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6', confirmButtonText: translations[currentLang].remove_item_confirm,
                cancelButtonText: translations[currentLang].remove_item_cancel
            });
            if (result.isConfirmed) { removeFromCart(cartItemId); }
        }

        async function removeFromCart(cartItemId) {
            Swal.fire({ title: translations[currentLang].alert_deleting, allowOutsideClick: false, didOpen: () => { Swal.showLoading(); }});
            const Net = Parse.Object.extend("Net");
            const cartItem = Net.createWithoutData(cartItemId);
            try {
                await cartItem.destroy();
                updateCartCount();
                showCartModal();
                Swal.close();
            } catch (error) {
                console.error("Error removing from cart:", error);
                Swal.fire(translations[currentLang].alert_error_title, translations[currentLang].alert_delete_fail, 'error');
            }
        }

        function showLanguageSwitcherModal() {
            Swal.fire({
                title: translations[currentLang].language,
                html: `<button class="lang-modal-btn" data-lang="ar">العربية</button><button class="lang-modal-btn" data-lang="en">English</button><button class="lang-modal-btn" data-lang="es">Español</button>`,
                showConfirmButton: false, showCloseButton: true, background: '#212534',
                customClass: { title: 'text-white' },
                didOpen: (modal) => {
                    modal.querySelectorAll('.lang-modal-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            setLanguage(e.target.dataset.lang);
                            Swal.close();
                        });
                    });
                }
            });
        }
        
        // --- FINAL SETUP AND EVENT LISTENERS ---
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const langGlobeButton = document.getElementById('lang-globe-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const trackOrdersBtn = document.getElementById('track-orders-btn');
        const trackOrdersBtnMobile = document.getElementById('track-orders-btn-mobile');

        if(mobileMenuButton) { mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden')); }
        if(langGlobeButton) { langGlobeButton.addEventListener('click', showLanguageSwitcherModal); }
        if(trackOrdersBtn) { trackOrdersBtn.addEventListener('click', showTrackingModal); }
        if(trackOrdersBtnMobile) { trackOrdersBtnMobile.addEventListener('click', showTrackingModal); }

        document.querySelectorAll('.lang-switcher').forEach(s => s.addEventListener('click', e => {
            setLanguage(e.target.dataset.lang);
            if(mobileMenu) mobileMenu.classList.add('hidden');
        }));

        document.getElementById('cart-button').addEventListener('click', showCartModal);
        
        const loginButtons = [document.getElementById('login-button'), document.getElementById('login-button-mobile')];
        const logoutButtons = [document.getElementById('logout-button'), document.getElementById('logout-button-mobile')];
        logoutButtons.forEach(btn => {
            if (btn) {
                btn.addEventListener('click', async () => {
                    try { await Parse.User.logOut(); window.location.reload(); }
                    catch (error) { console.error("Logout failed:", error); alert(`Logout failed: ${error.message}`); }
                });
            }
        });
        
        const walletLinks = [document.querySelector('a[href="wallet.html"]'), document.querySelector('#mobile-menu a[href="wallet.html"]')];

        if (!currentUser) {
            logoutButtons.forEach(btn => btn.style.display = 'none');
            loginButtons.forEach(btn => btn.classList.remove('hidden'));
            walletLinks.forEach(link => { if(link) link.style.display = 'none' });
            if(trackOrdersBtn) trackOrdersBtn.style.display = 'none';
            if(trackOrdersBtnMobile) trackOrdersBtnMobile.style.display = 'none';
        } else {
            loginButtons.forEach(btn => btn.style.display = 'none');
            logoutButtons.forEach(btn => btn.classList.remove('hidden'));
            walletLinks.forEach(link => { if(link) link.style.display = 'block' });
            if(trackOrdersBtn) trackOrdersBtn.style.display = 'inline-block';
            if(trackOrdersBtnMobile) trackOrdersBtnMobile.style.display = 'block';
            fetchUserWallet();
            updateCartCount();
        }

        searchInput.addEventListener('input', applyFiltersAndRender);
        categoryFilter.addEventListener('change', applyFiltersAndRender);

        // Initial Load
        setLanguage('ar');
        fetchProducts();
    });
    </script>
</body>
</html>
